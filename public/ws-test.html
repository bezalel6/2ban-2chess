<!doctype html>
<html>
  <head>
    <title>WebSocket Tester</title>
    <style>
      body {
        font-family: 'Segoe UI', monospace;
        padding: 20px;
        background: #0a0a0a;
        color: #e0e0e0;
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: #4f9eff;
        border-bottom: 2px solid #2a4a7a;
        padding-bottom: 10px;
      }
      .controls {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #333;
      }
      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
      }
      .input-group label {
        min-width: 100px;
        color: #888;
      }
      input[type='text'] {
        flex: 1;
        padding: 10px;
        background: #2a2a2a;
        border: 1px solid #444;
        color: #fff;
        border-radius: 4px;
        font-family: monospace;
        font-size: 14px;
      }
      input[type='text']:focus {
        outline: none;
        border-color: #4f9eff;
        background: #333;
      }
      .preset-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }
      button {
        padding: 10px 20px;
        background: #2a4a7a;
        color: #fff;
        border: 1px solid #3a5a8a;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.2s;
      }
      button:hover {
        background: #3a5a8a;
        transform: translateY(-1px);
      }
      button.danger {
        background: #7a2a2a;
        border-color: #8a3a3a;
      }
      button.danger:hover {
        background: #8a3a3a;
      }
      button.success {
        background: #2a7a4a;
        border-color: #3a8a5a;
      }
      button.success:hover {
        background: #3a8a5a;
      }
      .test-result {
        margin: 10px 0;
        padding: 15px;
        background: #1a1a1a;
        border-radius: 6px;
        border-left: 4px solid #444;
        font-family: monospace;
        font-size: 13px;
        line-height: 1.5;
      }
      .test-result.success {
        border-left-color: #4f9;
        background: #1a2a1a;
      }
      .test-result.error {
        border-left-color: #f44;
        background: #2a1a1a;
      }
      .test-result.pending {
        border-left-color: #ff4;
        background: #2a2a1a;
      }
      .test-result.info {
        border-left-color: #4af;
        background: #1a1a2a;
      }
      .timestamp {
        color: #666;
        font-size: 11px;
      }
      .message-content {
        margin-top: 5px;
        word-break: break-all;
      }
      .stats {
        display: flex;
        gap: 20px;
        padding: 10px;
        background: #1a1a1a;
        border-radius: 6px;
        margin-bottom: 20px;
      }
      .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #4f9eff;
      }
      .stat-label {
        font-size: 12px;
        color: #888;
        text-transform: uppercase;
      }
      #results {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 10px;
        background: #0f0f0f;
      }
      .connection-status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .status-connected {
        background: #2a7a4a;
        color: #4f9;
      }
      .status-disconnected {
        background: #7a2a2a;
        color: #f44;
      }
      .status-connecting {
        background: #7a7a2a;
        color: #ff4;
      }
    </style>
  </head>
  <body>
    <h1>üîå WebSocket Connection Tester</h1>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="total-tests">0</div>
        <div class="stat-label">Tests Run</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="successful-tests">0</div>
        <div class="stat-label">Successful</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="failed-tests">0</div>
        <div class="stat-label">Failed</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="connection-status">
          <span class="connection-status status-disconnected"
            >Disconnected</span
          >
        </div>
        <div class="stat-label">Current Status</div>
      </div>
    </div>

    <div class="controls">
      <div class="input-group">
        <label for="ws-url">WebSocket URL:</label>
        <input
          type="text"
          id="ws-url"
          placeholder="wss://ws-chess.rndev.site"
          value="wss://ws-chess.rndev.site"
        />
      </div>

      <div class="preset-buttons">
        <button onclick="setUrl('wss://ws-chess.rndev.site')">
          Production (ws-chess)
        </button>
        <button onclick="setUrl('wss://ws.chess.rndev.site')">
          Old Production (ws.chess)
        </button>
        <button onclick="setUrl('ws://localhost:3001')">Local Dev</button>
        <button onclick="setUrl('ws://rndev.local:3001')">Local Network</button>
        <button onclick="setUrl('ws://192.168.0.182:3001')">Direct IP</button>
      </div>

      <div style="display: flex; gap: 10px">
        <button class="success" onclick="testConnection()">
          üöÄ Test Connection
        </button>
        <button onclick="sendPing()">üì° Send Ping</button>
        <button onclick="sendCustom()">üì§ Send Custom Message</button>
        <button class="danger" onclick="disconnect()">üîå Disconnect</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
      </div>

      <div class="input-group" style="margin-top: 15px">
        <label for="custom-message">Custom Message:</label>
        <input
          type="text"
          id="custom-message"
          placeholder='{"type": "ping"}'
          value='{"type": "ping"}'
        />
      </div>
    </div>

    <div id="results"></div>

    <script>
      let ws = null;
      let stats = {
        total: 0,
        successful: 0,
        failed: 0,
      };

      function updateStats() {
        document.getElementById('total-tests').textContent = stats.total;
        document.getElementById('successful-tests').textContent =
          stats.successful;
        document.getElementById('failed-tests').textContent = stats.failed;
      }

      function updateConnectionStatus(status) {
        const statusEl = document.getElementById('connection-status');
        let className = 'status-disconnected';
        let text = 'Disconnected';

        switch (status) {
          case 'connected':
            className = 'status-connected';
            text = 'Connected';
            break;
          case 'connecting':
            className = 'status-connecting';
            text = 'Connecting';
            break;
          case 'disconnected':
            className = 'status-disconnected';
            text = 'Disconnected';
            break;
        }

        statusEl.innerHTML = `<span class="connection-status ${className}">${text}</span>`;
      }

      function log(message, type = 'info') {
        const results = document.getElementById('results');
        const entry = document.createElement('div');
        entry.className = `test-result ${type}`;

        const timestamp = new Date().toLocaleTimeString();
        entry.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div class="message-content">${message}</div>
            `;

        results.insertBefore(entry, results.firstChild);

        // Keep only last 100 messages
        while (results.children.length > 100) {
          results.removeChild(results.lastChild);
        }
      }

      function setUrl(url) {
        document.getElementById('ws-url').value = url;
        log(`URL set to: ${url}`, 'info');
      }

      function disconnect() {
        if (ws) {
          log('Closing connection...', 'info');
          ws.close();
          ws = null;
        } else {
          log('No active connection to close', 'error');
        }
      }

      function testConnection() {
        const url = document.getElementById('ws-url').value;

        if (!url) {
          log('Please enter a WebSocket URL', 'error');
          return;
        }

        // Close existing connection if any
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.close();
          ws = null;
          log('Closed existing connection', 'info');
        }

        stats.total++;
        updateStats();

        log(`Attempting to connect to: ${url}`, 'pending');
        updateConnectionStatus('connecting');

        try {
          ws = new WebSocket(url);

          let connectionTimeout = setTimeout(() => {
            if (ws.readyState !== WebSocket.OPEN) {
              log('Connection timeout after 10 seconds', 'error');
              ws.close();
              stats.failed++;
              updateStats();
              updateConnectionStatus('disconnected');
            }
          }, 10000);

          ws.onopen = function (event) {
            clearTimeout(connectionTimeout);
            log(`‚úÖ Connected successfully to ${url}`, 'success');
            log(
              `Ready state: ${ws.readyState} | Protocol: ${ws.protocol || 'none'}`,
              'info'
            );
            stats.successful++;
            updateStats();
            updateConnectionStatus('connected');

            // Send initial ping
            try {
              ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
              log('üì§ Sent initial ping', 'info');
            } catch (e) {
              log(`Failed to send ping: ${e.message}`, 'error');
            }
          };

          ws.onmessage = function (event) {
            log(`üì• Received: ${event.data}`, 'success');

            // Try to parse and pretty print JSON
            try {
              const data = JSON.parse(event.data);
              log(`Parsed message: ${JSON.stringify(data, null, 2)}`, 'info');
            } catch (e) {
              // Not JSON, that's okay
            }
          };

          ws.onerror = function (event) {
            clearTimeout(connectionTimeout);
            log(`‚ùå WebSocket error occurred`, 'error');
            stats.failed++;
            updateStats();
            updateConnectionStatus('disconnected');
          };

          ws.onclose = function (event) {
            clearTimeout(connectionTimeout);
            let message = `Connection closed - Code: ${event.code}`;
            if (event.reason) {
              message += `, Reason: ${event.reason}`;
            }

            if (event.code === 1000) {
              log(`üëã ${message}`, 'info');
            } else {
              log(`‚ùå ${message}`, 'error');

              // Common error codes
              switch (event.code) {
                case 1006:
                  log(
                    'Abnormal closure (network error, CORS, or server unreachable)',
                    'error'
                  );
                  break;
                case 1015:
                  log('TLS handshake failure (certificate issue)', 'error');
                  break;
              }
            }
            updateConnectionStatus('disconnected');
          };
        } catch (error) {
          log(`‚ùå Failed to create WebSocket: ${error.message}`, 'error');
          stats.failed++;
          updateStats();
          updateConnectionStatus('disconnected');
        }
      }

      function sendPing() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          log('No active connection. Connect first!', 'error');
          return;
        }

        try {
          const message = JSON.stringify({
            type: 'ping',
            timestamp: Date.now(),
            origin: window.location.origin,
          });
          ws.send(message);
          log(`üì§ Sent: ${message}`, 'info');
        } catch (error) {
          log(`Failed to send ping: ${error.message}`, 'error');
        }
      }

      function sendCustom() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          log('No active connection. Connect first!', 'error');
          return;
        }

        const message = document.getElementById('custom-message').value;
        if (!message) {
          log('Please enter a message to send', 'error');
          return;
        }

        try {
          ws.send(message);
          log(`üì§ Sent custom: ${message}`, 'info');
        } catch (error) {
          log(`Failed to send message: ${error.message}`, 'error');
        }
      }

      function clearLogs() {
        document.getElementById('results').innerHTML = '';
        log('Logs cleared', 'info');
      }

      // Add keyboard shortcuts
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && e.ctrlKey) {
          testConnection();
        } else if (e.key === 'Escape') {
          disconnect();
        }
      });

      // Initial log
      log(
        `Test page loaded. Current origin: ${window.location.origin}`,
        'info'
      );
      log('Press Ctrl+Enter to test connection, Esc to disconnect', 'info');
    </script>
  </body>
</html>
